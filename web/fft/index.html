<!DOCTYPE html>
<html>
<head>
  <title>AcoustSee - Webcam FFT Audio</title>
  <style>
    canvas { 
      border: 1px solid black; 
      margin: 10px; 
    }
    #error { 
      color: red; 
      margin: 10px; 
      font-family: Arial, sans-serif;
    }
    #log { 
      margin: 10px; 
      padding: 10px; 
      background: #f0f0f0; 
      max-height: 200px; 
      overflow-y: auto; 
      font-family: monospace; 
      font-size: 12px; 
    }
    button { 
      padding: 10px 20px; 
      font-size: 16px; 
      cursor: pointer;
      margin: 10px;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <video id="video" autoplay width="320" height="240" style="display: none;"></video>
  <canvas id="canvas" width="320" height="240"></canvas>
  <button onclick="toggleAudio()" disabled>Start Audio</button>
  <p id="error"></p>
  <div id="log"></div>

  <script src="fft.js"></script>
  <script>
    // Global variables
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const errorDisplay = document.getElementById('error');
    const audioButton = document.querySelector('button');
    const logDisplay = document.getElementById('log');
    let audioCtx = null;
    let oscillator = null;
    let gainNode = null;
    let videoStream = null;
    const logs = [];

    // On-screen logging
    function addLog(message) {
      logs.push(`${new Date().toLocaleTimeString()}: ${message}`);
      if (logs.length > 20) logs.shift(); // Keep last 20 logs
      logDisplay.textContent = logs.join('\n');
      logDisplay.scrollTop = logDisplay.scrollHeight;
    }

    // Override console for mobile
    console.log = function(message) {
      addLog(message);
    };
    console.error = function(message) {
      addLog('ERROR: ' + message);
    };

    // Webcam setup
    async function setupWebcam() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 320 }, height: { ideal: 240 }, frameRate: { ideal: 30 } }
        });
        video.srcObject = videoStream;
        video.play();
        video.oncanplay = () => {
          console.log('Video ready, starting frame processing');
          errorDisplay.textContent = '';
          audioButton.disabled = false; // Enable audio button
          // Adjust canvas to match video aspect ratio
          const videoWidth = video.videoWidth;
          const videoHeight = video.videoHeight;
          const canvasAspect = canvas.width / canvas.height;
          const videoAspect = videoWidth / videoHeight;
          if (Math.abs(canvasAspect - videoAspect) > 0.01) {
            canvas.height = canvas.width / videoAspect;
            console.log(`Adjusted canvas height to ${canvas.height} for aspect ratio ${videoAspect}`);
          }
          processFrame();
        };
      } catch (err) {
        console.error('Webcam access failed: ' + err.message);
        errorDisplay.textContent = 'Error: No webcam detected or access denied. Audio disabled.';
        audioButton.disabled = true;
      }
    }

    // Audio toggle
    function toggleAudio() {
      if (!audioCtx) {
        audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') {
          audioCtx.resume().then(() => console.log('AudioContext resumed'));
        }
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); // 10% volume
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
        oscillator.connect(gainNode).connect(audioCtx.destination);
        oscillator.start();
        audioButton.textContent = 'Stop Audio';
        console.log('Audio started');
      } else {
        oscillator.stop();
        oscillator.disconnect();
        audioCtx.close();
        audioCtx = null;
        oscillator = null;
        gainNode = null;
        audioButton.textContent = 'Start Audio';
        console.log('Audio stopped');
      }
    }

    // FFT setup
    const width = canvas.width;
    let height = canvas.height; // Will be adjusted dynamically
    let fft = null;
    if (typeof FFT === 'undefined') {
      console.error('FFT.js library not loaded');
      errorDisplay.textContent = 'Error: FFT.js library failed to load. Please check the fft.js file.';
    } else {
      fft = new FFT(width * height);
      console.log('FFT initialized');
    }
    let input = new Array(width * height).fill(0);
    let output = new Array(width * height * 2).fill(0);

    // Frame processing
    let lastFrameTime = 0;
    function processFrame(timestamp) {
      if (timestamp - lastFrameTime < 33) { // Limit to ~30 FPS
        requestAnimationFrame(processFrame);
        return;
      }
      lastFrameTime = timestamp;

      if (video.readyState !== video.HAVE_ENOUGH_DATA) {
        console.log('Video not ready, skipping frame');
        requestAnimationFrame(processFrame);
        return;
      }

      // Draw video with preserved aspect ratio
      ctx.drawImage(video, 0, 0, width, height);
      const imageData = ctx.getImageData(0, 0, width, height).data;

      for (let i = 0, j = 0; i < imageData.length; i += 4, j++) {
        const r = imageData[i];
        const g = imageData[i + 1];
        const b = imageData[i + 2];
        input[j] = 0.299 * r + 0.587 * g + 0.114 * b; // Grayscale
      }

      if (fft) {
        fft.forward(input, output);

        let energy = 0;
        const lowFreqCount = Math.floor(width * height / 10);
        for (let i = 0; i < lowFreqCount * 2; i += 2) {
          const real = output[i];
          const imag = output[i + 1];
          energy += Math.sqrt(real * real + imag * imag);
        }
        energy /= lowFreqCount;

        if (audioCtx && oscillator) {
          const freq = 100 + (energy / 255) * 700; // Map to 100-800 Hz
          oscillator.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.01);
          console.log('Frequency: ' + freq.toFixed(2) + ' Hz');
        }
      } else {
        console.log('Skipping FFT: library not loaded');
      }

      requestAnimationFrame(processFrame);
    }

    // Initialize webcam
    setupWebcam();
  </script>
</body>
</html>
